<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>تطبيق الراوي</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Tajawal', 'sans-serif'] },
                    colors: { 
                        storytel: { 
                            orange: '#E55937', 
                            dark: '#181818', 
                            darker: '#121212', 
                            light: '#F8F8F8',
                            gray: '#2F2F2F'
                        }
                    }
                }
            }
        }
    </script>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        body { font-family: 'Tajawal', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        /* شريط التمرير */
        input[type=range] { -webkit-appearance: none; background: transparent; height: 4px; border-radius: 2px; cursor: pointer; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: rgba(128, 128, 128, 0.3); border-radius: 2px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #E55937; margin-top: -6px; box-shadow: 0 0 5px rgba(0,0,0,0.3); transition: transform 0.1s; }
        input[type=range]:active::-webkit-slider-thumb { transform: scale(1.2); }
    </style>
</head>
<body class="bg-storytel-light text-gray-900 transition-colors duration-300 selection:bg-storytel-orange selection:text-white">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- ICONS ---
        const Icon = ({ children, size = 24, className = "", ...props }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>);
        const Play = (p) => <Icon {...p}><polygon points="5 3 19 12 5 21 5 3"></polygon></Icon>;
        const Pause = (p) => <Icon {...p}><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></Icon>;
        const Home = (p) => <Icon {...p}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></Icon>;
        const Search = (p) => <Icon {...p}><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></Icon>;
        const Library = (p) => <Icon {...p}><path d="m16 6 4 14"></path><path d="M12 6v14"></path><path d="M8 8v12"></path><path d="M4 4v16"></path></Icon>;
        const Heart = (p) => <Icon {...p}><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"></path></Icon>;
        const ChevronDown = (p) => <Icon {...p}><polyline points="6 9 12 15 18 9"></polyline></Icon>;
        const ChevronRight = (p) => <Icon {...p}><polyline points="9 18 15 12 9 6"></polyline></Icon>;
        const ArrowLeft = (p) => <Icon {...p}><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></Icon>;
        const Settings = (p) => <Icon {...p}><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></Icon>;
        const Bell = (p) => <Icon {...p}><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"></path><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"></path></Icon>;
        const User = (p) => <Icon {...p}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></Icon>;
        const Edit2 = (p) => <Icon {...p}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></Icon>;
        const Star = ({ filled, half, size = 16, className = "", onClick, onMouseEnter }) => (
            <svg onClick={onClick} onMouseEnter={onMouseEnter} xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill={filled ? "#FFD700" : "none"} stroke={filled ? "#FFD700" : "currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
            </svg>
        );
        const MessageCircle = (p) => <Icon {...p}><path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"></path></Icon>;
        const X = (p) => <Icon {...p}><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></Icon>;
        const SendIcon = (p) => <Icon {...p}><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></Icon>;
        const Moon = (p) => <Icon {...p}><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></Icon>;
        const Sun = (p) => <Icon {...p}><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></Icon>;
        const Globe = (p) => <Icon {...p}><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10z"></path></Icon>;
        const Camera = (p) => <Icon {...p}><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"></path><circle cx="12" cy="13" r="3"></circle></Icon>;
        const Trash2 = (p) => <Icon {...p}><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></Icon>;
        const RotateCcw = (p) => <Icon {...p}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path></Icon>;
        const RotateCw = (p) => <Icon {...p}><path d="M21 12a9 9 0 1 1-9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path><path d="M21 3v5h-5"></path></Icon>;
        const Shuffle = (p) => <Icon {...p}><polyline points="16 3 21 3 21 8"></polyline><line x1="4" y1="20" x2="21" y2="3"></line><polyline points="21 16 21 21 16 21"></polyline><line x1="15" y1="15" x2="21" y2="21"></line><line x1="4" y1="4" x2="9" y2="9"></line></Icon>;
        const Repeat = (p) => <Icon {...p}><path d="m17 2 4 4-4 4"></path><path d="M3 11v-1a4 4 0 0 1 4-4h14"></path><path d="m7 22-4-4 4-4"></path><path d="M21 13v1a4 4 0 0 1-4 4H3"></path></Icon>;
        const MoreHorizontal = (p) => <Icon {...p}><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></Icon>;
        
        // --- DATA CONSTANTS ---
        const IMG_ZIKOLA = "https://raw.githubusercontent.com/SADXXXXXXXXX/MY_app_assets/refs/heads/main/%D8%A7%D8%B1%D8%B6%20%D8%B2%D9%8A%D9%83%D9%88%D9%84%D8%A7_2026-01-01_11-48-31.jpg";
        const IMG_AMARITA = "https://raw.githubusercontent.com/SADXXXXXXXXX/MY_app_assets/refs/heads/main/%D8%A7%D9%85%D8%A7%D8%B1%D9%8A%D8%AA%D8%A7_2026-01-01_11-48-35.jpg";
        const IMG_ARJAA = "https://raw.githubusercontent.com/SADXXXXXXXXX/MY_app_assets/refs/heads/main/%D8%A7%D9%84%D8%B9%D8%B1%D8%AC%D8%A7%D8%A1-288-k483128.jpg";
        const IMG_SAHIRA = "https://raw.githubusercontent.com/SADXXXXXXXXX/MY_app_assets/refs/heads/main/%D8%A7%D9%84%D8%B3%D8%A7%D8%AD%D8%B1%D8%A9%20%D8%A7%D9%84%D9%87%D8%AC%D9%8A%D9%86%D8%A9_2026-01-01_11-48-43.jpg";
        const IMG_ROT = "https://raw.githubusercontent.com/SADXXXXXXXXX/MY_app_assets/refs/heads/main/%D8%A7%D9%86%D9%86%D9%8A%20%D8%A7%D8%AA%D8%B9%D9%81%D9%86%20%D8%B1%D8%B9%D8%A8%D8%A7_2026-01-01_11-48-16.jpg";
        const IMG_KHOF_1 = "https://raw.githubusercontent.com/SADXXXXXXXXX/MY_app_assets/refs/heads/main/%D8%AE%D9%88%D9%81_2026-01-01_11-47-57.jpg";
        const IMG_KHOF_2 = "https://raw.githubusercontent.com/SADXXXXXXXXX/MY_app_assets/refs/heads/main/%D8%AE%D9%88%D9%81%20%D8%A7%D9%84%D8%AC%D8%B2%D8%A1%20%D8%A7%D9%84%D8%AB%D8%A7%D9%86%D9%8A%D9%8A.jpg";
        const IMG_KHOF_3 = "https://raw.githubusercontent.com/SADXXXXXXXXX/MY_app_assets/refs/heads/main/%D8%AE%D9%88%D9%81%20%D8%A7%D9%84%D8%AC%D8%B2%D8%A1%20%D8%A7%D9%84%D8%AB%D8%A7%D9%84%D8%AB_2026-01-01_11-48-08.jpg";
        const IMG_BASATIN = "https://raw.githubusercontent.com/SADXXXXXXXXX/MY_app_assets/refs/heads/main/%D8%A8%D8%B3%D8%A7%D8%AA%D9%8A%D9%86%20%D8%B9%D8%B1%D8%A8%D8%B3%D8%AA%D8%A7%D9%86_2026-01-01_11-47-53.jpg";
        const IMG_WADI = "https://raw.githubusercontent.com/SADXXXXXXXXX/MY_app_assets/refs/heads/main/%D9%88%D8%A7%D8%AF%20%D8%A7%D9%84%D8%B0%D8%A6%D8%A7%D8%A8%20%D8%A7%D9%84%D9%85%D9%86%D8%B3%D9%8A%D8%A9_2026-01-01_11-48-27.jpg";
        const IMG_GARTIN = "https://raw.githubusercontent.com/SADXXXXXXXXX/MY_app_assets/refs/heads/main/%D9%82%D9%88%D8%A7%D8%B9%D8%AF%20%D8%AC%D8%A7%D8%B1%D8%AA%D9%8A%D9%86_2026-01-01_11-48-01.jpg";
        const IMG_ARIN = "https://raw.githubusercontent.com/SADXXXXXXXXX/MY_app_assets/refs/heads/main/%D8%B9%D8%B1%D9%8A%D9%86%20%D8%A7%D9%84%D8%A7%D8%B3%D8%AF_2026-01-01_11-48-20.jpg";
        const IMG_PUCCINI = "https://raw.githubusercontent.com/SADXXXXXXXXX/MY_app_assets/refs/heads/main/%D9%8A%D8%AA%D8%B4%D9%8A%D9%86%D9%8A_2026-01-01_16-29-26.jpg";
        const IMG_SHAMA = "https://raw.githubusercontent.com/SADXXXXXXXXX/MY_app_assets/refs/heads/main/%D8%AF%D9%82%D8%A7%D8%AA%20%D8%A7%D9%84%D8%B4%D8%A7%D9%85%D9%8843749543.jpg";
        const IMG_AKMA = "https://raw.githubusercontent.com/SADXXXXXXXXX/MY_app_assets/refs/heads/main/%D8%A7%D9%85%D9%88%D8%A7%D8%AC%20%D8%A7%D9%83%D9%85%D8%A7_1580249491129-336x480.jpg";
        const IMG_RAYAH = "https://raw.githubusercontent.com/SADXXXXXXXXX/MY_app_assets/refs/heads/main/%D8%B1%D9%8A%D8%A7%D8%AD%20%D9%87%D8%AC%D8%B1_2026-01-01_11-48-12.jpg";
        const IMG_ASBA = "https://raw.githubusercontent.com/SADXXXXXXXXX/MY_app_assets/refs/heads/main/%D8%B9%D8%B5%D8%A8%D8%A9-%D8%A7%D9%84%D8%B4%D9%8A%D8%A7%D8%B7%D9%8A%D9%86.jpg";
        const IMG_UKTUB = "https://raw.githubusercontent.com/SADXXXXXXXXX/MY_app_assets/refs/heads/main/%D8%A3%D9%83%D8%AA%D8%A8-%D8%AD%D8%AA%D9%89-%D9%84%D8%A7-%D9%8A%D8%A3%D9%83%D9%84%D9%86%D9%8A-%D8%A7%D9%84%D8%B4%D9%8A%D8%B7%D8%A7%D9%86-%D9%85%D8%A7%D8%B1%D9%8A%D8%A7-%D8%A7%D9%84%D8%AD%D8%B3%D9%8A%D9%8A-pdf.jpg";

        // الوصف (Descriptions)
        const NOVEL_DESCRIPTIONS = {
            "خوف - الجزء الأول": "في عالم يلفه الغموض والظلام، تبدأ رحلة 'خوف'، الشاب الذي وجد نفسه فجأة منغمساً في عوالم الجن والشياطين السفليّة. لم يكن فضوله مجرد رغبة في المعرفة، بل كان بوابة فتحت عليه أبواب الجحيم.",
            "بساتين عربستان": "قبل قرون من الزمن، في أرض لم تطأها أقدام الغرباء، بدأت قصة الانتقام والسحر. بساتين عربستان ليست مجرد رواية تاريخية، بل هي ملحمة تروي سيرة ساحرتين، أفسار ودعجاء.",
            "أرض زيكولا": "هل تخيلت يوماً أن يكون ذكاؤك هو عملتك؟ في أرض زيكولا، لا مكان للمال، فكل ما تملك هو وحدات ذكاء تدفعها مقابل الطعام والشراب والحياة.",
            "قواعد جارتين": "مرحباً بك في جارتين، المدينة التي تحكمها قواعد صارمة لا تقبل النقاش. القاعدة الأهم والأقسى: لا أحد يعيش أكثر من خمسين عاماً.",
            "إنني أتعفن رعباً": "رواية رعب نفسي من الطراز الرفيع. تدور الأحداث حول شخصية تعيش صراعاً مريراً مع هلوسات وكوابيس تبدو حقيقية جداً.",
            "بيتشيني": "في أجواء يلفها الغموض والتوتر، تنطلق أحداث بيتشيني. لغز قديم يعود للظهور ليهدد حياة الأبطال."
        };

        const DEFAULT_AUDIO = "https://huggingface.co/datasets/dassss777/audio_novels_dd/resolve/main/Track.m4a";

        // البيانات
        const seriesData = [
            { id: 's_khof', title: "سلسلة خوف", author: "أسامة المسلم", coverImage: IMG_KHOF_1, coverColor: "from-red-900", books: [ 
                { id: 101, title: "خوف - الجزء الأول", duration: "08:30:00", genre: "رعب", audio: DEFAULT_AUDIO }, 
                { id: 102, title: "خوف - الجزء الثاني", duration: "09:15:00", genre: "رعب", audio: DEFAULT_AUDIO }, 
                { id: 103, title: "خوف - الجزء الثالث", duration: "10:00:00", genre: "رعب", audio: DEFAULT_AUDIO } 
            ] },
            { id: 's_basatin', title: "بساتين عربستان", author: "أسامة المسلم", coverImage: IMG_BASATIN, coverColor: "from-green-900", books: [ 
                { id: 201, title: "بساتين عربستان", duration: "11:00:00", genre: "خيال", audio: DEFAULT_AUDIO }, 
                { id: 202, title: "عصبة الشياطين", duration: "10:45:00", genre: "خيال", audio: DEFAULT_AUDIO }, 
                { id: 203, title: "رياح هجر", duration: "09:30:00", genre: "خيال", audio: DEFAULT_AUDIO }, 
                { id: 204, title: "العرجاء", duration: "10:15:00", genre: "خيال", audio: DEFAULT_AUDIO }, 
                { id: 205, title: "الساحرة الهجينة", duration: "09:50:00", genre: "خيال", audio: DEFAULT_AUDIO }, 
                { id: 206, title: "عرين الأسد", duration: "12:00:00", genre: "خيال", audio: DEFAULT_AUDIO } 
            ] },
            { id: 's_zikola', title: "أرض زيكولا", author: "عمرو عبد الحميد", coverImage: IMG_ZIKOLA, coverColor: "from-blue-900", books: [ 
                { id: 301, title: "أرض زيكولا", duration: "07:30:00", genre: "خيال", audio: DEFAULT_AUDIO }, 
                { id: 302, title: "أمار يتا", duration: "08:00:00", genre: "خيال", audio: DEFAULT_AUDIO }, 
                { id: 303, title: "وادي الذئاب المنسية", duration: "08:45:00", genre: "خيال", audio: DEFAULT_AUDIO } 
            ] },
            { id: 's_gartin', title: "قواعد جارتين", author: "عمرو عبد الحميد", coverImage: IMG_GARTIN, coverColor: "from-yellow-900", books: [ 
                { id: 401, title: "قواعد جارتين", duration: "09:00:00", genre: "دراما", audio: DEFAULT_AUDIO }, 
                { id: 402, title: "دقات الشامة", duration: "09:30:00", genre: "دراما", audio: DEFAULT_AUDIO }, 
                { id: 403, title: "أمواج أكما", duration: "10:00:00", genre: "دراما", audio: DEFAULT_AUDIO } 
            ] },
            { id: 's_uktub', title: "اكتب حتى لا يأكلني الشيطان", author: "مريم الحيسي", coverImage: IMG_UKTUB, coverColor: "from-gray-800", books: [ 
                { id: 501, title: "اكتب حتى لا يأكلني الشيطان", duration: "05:00:00", genre: "رعب", audio: DEFAULT_AUDIO } 
            ] }
        ];

        const booksData = [
            { id: 1, title: "إنني أتعفن رعباً", author: "مريم الحيسي", coverImage: IMG_ROT, coverColor: "from-red-950", duration: "04:20:00", genre: "رعب", chapters: [{ title: "الفصل الأول", duration: "45:00", audio: DEFAULT_AUDIO }] },
            { id: 2, title: "بيتشيني", author: "مريم الحيسي", coverImage: IMG_PUCCINI, coverColor: "from-pink-900", duration: "05:45:00", genre: "غموض", chapters: [{ title: "المقدمة", duration: "15:00", audio: DEFAULT_AUDIO }] }
        ];

        const translations = {
            ar: { home: "الرئيسية", search: "بحث", library: "مكتبتي", settings: "الإعدادات", greeting: "مرحباً بالقارئ", newArrivals: "أضيف حديثاً", mostListened: "الأكثر استماعاً", continueListening: "أكمل الاستماع", reviews: "التقييمات", summary: "النبذة", writeReview: "أضف تعليق", addReviewTitle: "قيم الرواية", cancel: "إلغاء", submitReview: "نشر", suggestions: "اقتراحات:" }
        };

        const CoverImage = ({ src, fallbackColor, className, children, title }) => {
            const [error, setError] = useState(false);
            if (error || !src) return <div className={`${className} bg-gradient-to-br ${fallbackColor || 'from-gray-800'} to-black flex items-center justify-center relative overflow-hidden flex-col text-center p-2`}><span className="font-bold text-white/90 text-xs">{title}</span>{children}</div>;
            return <div className={`${className} relative overflow-hidden`}><img src={src} alt="cover" className="w-full h-full object-cover" onError={() => setError(true)} /><div className="absolute inset-0 bg-black/10"></div>{children}</div>;
        };

        const formatTime = (seconds) => {
            if (!seconds) return "00:00";
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        };

        const normalizeText = (text) => text ? text.replace(/[أإآ]/g, 'ا').replace(/ة/g, 'ه').replace(/ى/g, 'ي').toLowerCase() : "";

        function App() {
            const [activeTab, setActiveTab] = useState('home');
            const [selectedSeries, setSelectedSeries] = useState(null);
            const [selectedBookDetail, setSelectedBookDetail] = useState(null);
            const [activeBookTab, setActiveBookTab] = useState('summary'); // للتبديل بين النبذة والتعليقات
            const [currentBook, setCurrentBook] = useState(null);
            const [isPlayerOpen, setIsPlayerOpen] = useState(false);
            const [isPlaying, setIsPlaying] = useState(false);
            const [progress, setProgress] = useState(0);
            const [theme, setTheme] = useState('dark');
            const [searchQuery, setSearchQuery] = useState('');
            const audioRef = useRef(new Audio());

            const isDark = theme === 'dark';

            // Reviews Logic
            const [isReviewModalOpen, setIsReviewModalOpen] = useState(false);
            const [bookReviews, setBookReviews] = useState({
                // بيانات تجريبية للتعليقات
                101: [{id: 1, user: "أحمد", rating: 5, text: "رواية ممتازة جداً!"}],
                301: [{id: 2, user: "سارة", rating: 4, text: "أحببت القصة."}]
            });
            const [tempRating, setTempRating] = useState(0);
            const [tempReview, setTempReview] = useState("");

            // User Profile
            const [userProfile, setUserProfile] = useState({ name: "مستخدم جديد", avatar: null });
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [isEditingProfile, setIsEditingProfile] = useState(false);
            const [tempName, setTempName] = useState(userProfile.name);
            const fileInputRef = useRef(null);

            const allAudioNovels = useMemo(() => {
                const fromSeries = seriesData.flatMap(s => s.books.map(b => ({ ...b, author: s.author, series: s.title, coverImage: b.coverImage || s.coverImage, coverColor: s.coverColor })));
                return [...booksData, ...fromSeries];
            }, []);

            useEffect(() => {
                if (isDark) document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
            }, [isDark]);

            const openBookPage = (book) => {
                const desc = NOVEL_DESCRIPTIONS[book.title] || "استمع الآن لأروع الروايات على تطبيق الراوي.";
                setSelectedBookDetail({ ...book, description: desc });
                setActiveBookTab('summary');
                setActiveTab('book_detail');
            };

            const playBook = (book) => {
                const audioUrl = book.audio || DEFAULT_AUDIO;
                if(audioRef.current.src !== audioUrl) {
                    audioRef.current.src = audioUrl;
                    audioRef.current.load();
                }
                setCurrentBook(book);
                setIsPlayerOpen(true);
                setIsPlaying(true);
                audioRef.current.play();
            };

            useEffect(() => {
                if(isPlaying) audioRef.current.play().catch(e=>console.log(e));
                else audioRef.current.pause();
            }, [isPlaying]);

            useEffect(() => {
                const audio = audioRef.current;
                const update = () => setProgress((audio.currentTime / audio.duration) * 100);
                audio.addEventListener('timeupdate', update);
                return () => audio.removeEventListener('timeupdate', update);
            }, []);

            // دالة التعليقات
            const submitReview = () => {
                if (tempRating === 0) return;
                const newReview = { id: Date.now(), user: userProfile.name, date: "الآن", rating: tempRating, text: tempReview };
                const bookId = selectedBookDetail.id;
                const updatedReviews = [newReview, ...(bookReviews[bookId] || [])];
                setBookReviews({ ...bookReviews, [bookId]: updatedReviews });
                setIsReviewModalOpen(false);
                setTempRating(0);
                setTempReview("");
            };

            const handleFileChange = (e) => { const file = e.target.files?.[0]; if (file) { const reader = new FileReader(); reader.onloadend = () => { setUserProfile(prev => ({ ...prev, avatar: reader.result })); }; reader.readAsDataURL(file); } };

            return (
                <div className={`flex flex-col h-screen font-sans overflow-hidden transition-colors duration-300 select-none ${isDark ? 'bg-storytel-darker text-white' : 'bg-storytel-light text-gray-900'}`}>
                    <div className="flex-1 overflow-y-auto pb-40">
                        {/* HEADER */}
                        <div className={`p-6 pt-10 flex justify-between items-center sticky top-0 z-30 backdrop-blur-md ${isDark ? 'bg-storytel-darker/90' : 'bg-white/90 shadow-sm'}`}>
                            <div className="flex items-center gap-3">
                                <div onClick={() => setIsSettingsOpen(true)} className="w-10 h-10 rounded-full bg-gray-600 flex items-center justify-center overflow-hidden cursor-pointer">
                                    {userProfile.avatar ? <img src={userProfile.avatar} className="w-full h-full object-cover" /> : <User className="text-white" />}
                                </div>
                                <div><h1 className="text-lg font-bold">{userProfile.name}</h1><p className="text-xs opacity-60">مرحباً بك</p></div>
                            </div>
                            <div className="flex gap-4">
                                <button onClick={() => setIsSettingsOpen(true)}><Settings className="opacity-60" /></button>
                            </div>
                        </div>

                        {/* HOME CONTENT */}
                        {activeTab === 'home' && (
                            <div className="px-4 space-y-8 mt-4">
                                {/* Continue Listening */}
                                <section>
                                    <h2 className="text-xl font-bold mb-4">أكمل الاستماع</h2>
                                    <div className="flex gap-4 overflow-x-auto scrollbar-hide pb-2">
                                        {[allAudioNovels[0], allAudioNovels[5]].map(book => (
                                            <div key={book.id} onClick={() => playBook(book)} className="flex-shrink-0 w-32 relative group cursor-pointer">
                                                <CoverImage src={book.coverImage} fallbackColor={book.coverColor} title={book.title} className="w-32 h-32 rounded-lg mb-2 shadow-md" />
                                                <div className="absolute bottom-2 right-0 left-0 h-1 bg-gray-700"><div className="h-full bg-storytel-orange w-1/2"></div></div>
                                                <h3 className="text-xs font-bold truncate">{book.title}</h3>
                                            </div>
                                        ))}
                                    </div>
                                </section>

                                {/* New Arrivals */}
                                <section>
                                    <h2 className="text-xl font-bold mb-4">أضيف حديثاً</h2>
                                    <div className="flex gap-4 overflow-x-auto scrollbar-hide pb-2">
                                        {allAudioNovels.slice(0, 5).map(book => (
                                            <div key={book.id} onClick={() => openBookPage(book)} className="flex-shrink-0 w-28 cursor-pointer">
                                                <CoverImage src={book.coverImage} fallbackColor={book.coverColor} title={book.title} className="w-28 h-40 rounded-lg mb-2 shadow-lg" />
                                                <h3 className="text-xs font-bold truncate">{book.title}</h3>
                                                <p className="text-[10px] opacity-60 truncate">{book.author}</p>
                                            </div>
                                        ))}
                                    </div>
                                </section>

                                {/* Series */}
                                <section>
                                    <h2 className="text-xl font-bold mb-4">السلاسل</h2>
                                    <div className="flex gap-4 overflow-x-auto scrollbar-hide">
                                        {seriesData.map(series => (
                                            <div key={series.id} onClick={() => { setSelectedSeries(series); setActiveTab('series_detail'); }} className={`flex-shrink-0 w-64 h-32 relative rounded-xl overflow-hidden cursor-pointer border ${isDark ? 'border-white/10' : 'border-gray-200 shadow'}`}>
                                                <div className={`absolute inset-0 bg-gradient-to-r ${series.coverColor} to-black opacity-80`}></div>
                                                <div className="absolute inset-0 p-4 flex items-center gap-4">
                                                    <CoverImage src={series.coverImage} className="w-16 h-20 rounded shadow-lg" />
                                                    <div className="text-white">
                                                        <h3 className="font-bold text-lg leading-tight">{series.title}</h3>
                                                        <p className="text-xs opacity-80">{series.books.length} أجزاء</p>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </section>
                            </div>
                        )}

                        {/* SERIES DETAIL */}
                        {activeTab === 'series_detail' && selectedSeries && (
                            <div className="min-h-full">
                                <div className={`relative h-64 bg-gradient-to-b ${selectedSeries.coverColor} ${isDark ? 'to-storytel-darker' : 'to-white'} flex flex-col items-center justify-center p-6 text-center`}>
                                    <button onClick={() => setActiveTab('home')} className="absolute top-10 right-6 bg-black/30 text-white p-2 rounded-full"><ArrowLeft /></button>
                                    <CoverImage src={selectedSeries.coverImage} className="w-32 h-44 rounded shadow-2xl mb-4" />
                                    <h1 className={`text-2xl font-bold ${isDark ? 'text-white' : 'text-gray-900'}`}>{selectedSeries.title}</h1>
                                </div>
                                <div className="p-4 space-y-2">
                                    {selectedSeries.books.map((book, i) => (
                                        <div key={book.id} onClick={() => openBookPage({...book, description: NOVEL_DESCRIPTIONS[book.title]})} className={`flex items-center gap-4 p-3 rounded-lg cursor-pointer ${isDark ? 'bg-white/5 hover:bg-white/10' : 'bg-gray-100 hover:bg-gray-200'}`}>
                                            <span className="text-storytel-orange font-bold text-lg w-6 text-center">{i+1}</span>
                                            <CoverImage src={book.coverImage || selectedSeries.coverImage} className="w-12 h-12 rounded" />
                                            <div><h3 className="font-bold text-sm">{book.title}</h3><p className="text-xs opacity-60">{book.duration}</p></div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* SEARCH */}
                        {activeTab === 'search' && (
                            <div className="p-4 pt-12">
                                <h1 className="text-3xl font-bold mb-6">بحث</h1>
                                <div className={`flex items-center gap-3 p-3 rounded-md mb-6 ${isDark ? 'bg-white text-black' : 'bg-gray-200 text-black'}`}>
                                    <Search size={22} className="opacity-70" />
                                    <input type="text" value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} placeholder="ابحث عن رواية..." className="bg-transparent border-none outline-none w-full text-sm font-semibold placeholder-gray-600 text-black text-right" />
                                </div>
                                <div className="space-y-4">
                                    {searchQuery && allAudioNovels.filter(b => normalizeText(b.title).includes(normalizeText(searchQuery))).map(book => (
                                        <div key={book.id} onClick={() => openBookPage(book)} className={`flex items-center gap-4 p-2 rounded-md cursor-pointer ${isDark ? 'hover:bg-white/10' : 'hover:bg-gray-100'}`}>
                                            <CoverImage src={book.coverImage} className="w-12 h-12 rounded" />
                                            <div><h3 className="font-bold text-sm">{book.title}</h3></div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* LIBRARY */}
                        {activeTab === 'library' && (
                            <div className="p-4 pt-12">
                                <h1 className="text-3xl font-bold mb-6">مكتبتي</h1>
                                <div className="flex flex-col items-center justify-center py-20 opacity-50">
                                    <Library size={48} className="mb-4" />
                                    <p>لا توجد كتب محفوظة بعد</p>
                                </div>
                            </div>
                        )}

                        {/* BOOK DETAIL PAGE (With Reviews Tab) */}
                        {activeTab === 'book_detail' && selectedBookDetail && (
                            <div className={`min-h-full animate-in slide-in-from-bottom-10 ${isDark ? 'bg-storytel-darker' : 'bg-white'}`}>
                                <div className={`relative h-[400px] bg-gradient-to-b ${selectedBookDetail.coverColor || 'from-gray-800'} ${isDark ? 'to-storytel-darker' : 'to-white'} p-6 flex flex-col items-center pt-20`}>
                                    <button onClick={() => setActiveTab('home')} className="absolute top-10 right-6 bg-black/30 text-white p-2 rounded-full"><ArrowLeft /></button>
                                    <CoverImage src={selectedBookDetail.coverImage} className="w-40 h-60 rounded-lg shadow-2xl mb-4" />
                                    <h1 className="text-2xl font-bold text-center mb-1">{selectedBookDetail.title}</h1>
                                    <p className="opacity-70 text-sm">{selectedBookDetail.author}</p>
                                    <div className="flex gap-4 mt-6 w-full max-w-sm">
                                        <button onClick={() => playBook(selectedBookDetail)} className="flex-1 bg-storytel-orange text-white py-3 rounded-full font-bold flex items-center justify-center gap-2"><Play fill="currentColor" /> استمع</button>
                                    </div>
                                </div>

                                {/* TABS SWITCHER */}
                                <div className={`flex border-b px-6 mb-4 ${isDark ? 'border-white/10' : 'border-gray-200'}`}>
                                    <button onClick={() => setActiveBookTab('summary')} className={`pb-3 px-4 font-bold text-sm transition-colors ${activeBookTab === 'summary' ? 'border-b-2 border-storytel-orange text-storytel-orange' : 'opacity-50'}`}>النبذة</button>
                                    <button onClick={() => setActiveBookTab('reviews')} className={`pb-3 px-4 font-bold text-sm transition-colors ${activeBookTab === 'reviews' ? 'border-b-2 border-storytel-orange text-storytel-orange' : 'opacity-50'}`}>التعليقات</button>
                                </div>

                                <div className="px-6 pb-32">
                                    {activeBookTab === 'summary' ? (
                                        <div className="leading-relaxed text-sm opacity-90">
                                            {selectedBookDetail.description}
                                            <div className="mt-4 flex gap-2">
                                                <span className={`px-3 py-1 rounded-full text-xs border ${isDark ? 'bg-white/5 border-white/10' : 'bg-gray-100 border-gray-200'}`}>{selectedBookDetail.genre || 'رواية'}</span>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="space-y-4">
                                            {/* Rating Header */}
                                            <div className={`flex justify-between items-center p-4 rounded-xl ${isDark ? 'bg-white/5' : 'bg-gray-100'}`}>
                                                <div><div className="text-3xl font-bold">4.8</div><div className="flex text-yellow-500"><Star filled /><Star filled /><Star filled /><Star filled /><Star filled half /></div></div>
                                                <button onClick={() => setIsReviewModalOpen(true)} className={`px-4 py-2 rounded-full text-xs font-bold flex gap-2 ${isDark ? 'bg-white/10 hover:bg-white/20' : 'bg-white shadow hover:bg-gray-50'}`}><Edit2 size={14} /> أضف تعليق</button>
                                            </div>
                                            
                                            {/* Reviews List */}
                                            <div className="space-y-3">
                                                {(bookReviews[selectedBookDetail.id] || []).map(review => (
                                                    <div key={review.id} className={`p-4 rounded-xl border ${isDark ? 'bg-white/5 border-white/5' : 'bg-white border-gray-100 shadow-sm'}`}>
                                                        <div className="flex justify-between mb-2">
                                                            <div className="font-bold text-sm">{review.user}</div>
                                                            <div className="flex text-yellow-500 text-xs">{(Array(review.rating).fill(0)).map((_,i)=><Star key={i} filled size={10} />)}</div>
                                                        </div>
                                                        <p className="text-sm opacity-80">{review.text}</p>
                                                    </div>
                                                ))}
                                                {(bookReviews[selectedBookDetail.id] || []).length === 0 && (
                                                    <div className="text-center py-8 opacity-50 text-sm">لا توجد تعليقات بعد. كن أول من يقيّم!</div>
                                                )}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                    </div>

                    {/* BOTTOM NAV */}
                    <div className={`fixed bottom-0 w-full h-20 border-t flex justify-around items-center z-40 pb-2 ${isDark ? 'bg-storytel-darker border-white/5' : 'bg-white border-gray-200'}`}>
                        <button onClick={() => setActiveTab('home')} className={`flex flex-col items-center gap-1 ${activeTab === 'home' ? 'text-storytel-orange' : 'opacity-50'}`}><Home /> <span className="text-[10px]">الرئيسية</span></button>
                        <button onClick={() => setActiveTab('search')} className={`flex flex-col items-center gap-1 ${activeTab === 'search' ? 'text-storytel-orange' : 'opacity-50'}`}><Search /> <span className="text-[10px]">بحث</span></button>
                        <button onClick={() => setActiveTab('library')} className={`flex flex-col items-center gap-1 ${activeTab === 'library' ? 'text-storytel-orange' : 'opacity-50'}`}><Library /> <span className="text-[10px]">مكتبتي</span></button>
                    </div>

                    {/* MINI PLAYER */}
                    {isPlaying && !isPlayerOpen && (
                        <div onClick={() => setIsPlayerOpen(true)} className={`fixed bottom-24 left-2 right-2 rounded-lg p-2 flex items-center justify-between shadow-xl z-50 border backdrop-blur-md cursor-pointer ${isDark ? 'bg-gray-800 border-white/10' : 'bg-white border-gray-200'}`}>
                            <div className="flex items-center gap-3">
                                <CoverImage src={currentBook?.coverImage} className="w-10 h-10 rounded" />
                                <div><h4 className="text-xs font-bold">{currentBook?.title}</h4><p className="text-[10px] opacity-60">{currentBook?.author}</p></div>
                            </div>
                            <button onClick={(e) => { e.stopPropagation(); setIsPlaying(!isPlaying); }} className={`rounded-full p-2 ${isDark ? 'bg-white text-black' : 'bg-black text-white'}`}><Pause fill="currentColor" size={16} /></button>
                        </div>
                    )}

                    {/* FULL PLAYER MODAL */}
                    {isPlayerOpen && currentBook && (
                        <div className={`fixed inset-0 z-[60] flex flex-col ${isDark ? 'bg-storytel-darker' : 'bg-white'}`}>
                            <div className="p-6 pt-10 flex justify-between">
                                <button onClick={() => setIsPlayerOpen(false)}><ChevronDown /></button>
                                <span className="text-xs uppercase tracking-widest opacity-50">جاري التشغيل</span>
                                <Settings />
                            </div>
                            <div className="flex-1 flex flex-col items-center justify-center p-8">
                                <CoverImage src={currentBook.coverImage} className="w-64 h-64 rounded-xl shadow-2xl mb-8" />
                                <h2 className="text-2xl font-bold text-center mb-1">{currentBook.title}</h2>
                                <p className="opacity-60">{currentBook.author}</p>
                            </div>
                            <div className="p-8 pb-10">
                                <input type="range" min="0" max="100" value={progress} onChange={(e) => {const v = e.target.value; setProgress(v); audioRef.current.currentTime = (v/100)*audioRef.current.duration;}} className="w-full mb-4" />
                                <div className="flex justify-center items-center gap-8">
                                    <button onClick={() => {audioRef.current.currentTime -= 10}} className="opacity-60 hover:opacity-100">-10</button>
                                    <button onClick={() => setIsPlaying(!isPlaying)} className={`w-20 h-20 rounded-full flex items-center justify-center shadow-lg hover:scale-105 transition ${isDark ? 'bg-white text-black' : 'bg-black text-white'}`}>
                                        {isPlaying ? <Pause fill="currentColor" size={32} /> : <Play fill="currentColor" size={32} className="ml-1" />}
                                    </button>
                                    <button onClick={() => {audioRef.current.currentTime += 10}} className="opacity-60 hover:opacity-100">+10</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* REVIEW MODAL */}
                    {isReviewModalOpen && (
                        <div className="fixed inset-0 z-[70] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
                            <div className={`w-full max-w-sm rounded-2xl p-6 border ${isDark ? 'bg-gray-900 border-white/10' : 'bg-white border-gray-200'}`}>
                                <h3 className="text-xl font-bold text-center mb-6">ما رأيك في الرواية؟</h3>
                                <div className="flex justify-center gap-2 mb-6">
                                    {[1,2,3,4,5].map(s => <button key={s} onClick={() => setTempRating(s)}><Star size={32} filled={s <= tempRating} className={s <= tempRating ? "text-yellow-500" : "text-gray-400"} /></button>)}
                                </div>
                                <textarea value={tempReview} onChange={e => setTempReview(e.target.value)} placeholder="اكتب تعليقك هنا..." className={`w-full rounded-lg p-3 text-sm h-24 mb-4 border outline-none ${isDark ? 'bg-black/30 border-white/5 focus:border-storytel-orange' : 'bg-gray-50 border-gray-200 focus:border-storytel-orange'}`}></textarea>
                                <div className="flex gap-3">
                                    <button onClick={() => setIsReviewModalOpen(false)} className={`flex-1 py-3 rounded-lg ${isDark ? 'bg-gray-800' : 'bg-gray-200'}`}>إلغاء</button>
                                    <button onClick={submitReview} className="flex-1 py-3 rounded-lg bg-storytel-orange text-white font-bold">نشر</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* SETTINGS MODAL */}
                    {isSettingsOpen && (
                        <div className={`fixed inset-0 z-50 overflow-y-auto ${isDark ? 'bg-black' : 'bg-gray-50'}`}>
                            <div className="p-6">
                                <div className="flex items-center gap-4 mb-8">
                                    <button onClick={() => setIsSettingsOpen(false)}><ArrowLeft size={24} className="rotate-180" /></button>
                                    <h2 className="text-xl font-bold">الإعدادات</h2>
                                </div>
                                <div className="flex flex-col items-center mb-10">
                                    <div className="relative mb-4 group">
                                        <div onClick={() => fileInputRef.current?.click()} className="w-24 h-24 rounded-full bg-gray-600 overflow-hidden cursor-pointer flex items-center justify-center">
                                            {userProfile.avatar ? <img src={userProfile.avatar} className="w-full h-full object-cover" /> : <Camera className="text-white" />}
                                        </div>
                                        <input type="file" ref={fileInputRef} onChange={handleFileChange} accept="image/*" className="hidden" />
                                    </div>
                                    {isEditingProfile ? (
                                        <div className="flex flex-col gap-2">
                                            <input value={tempName} onChange={e => setTempName(e.target.value)} className="bg-transparent border-b text-center text-xl font-bold outline-none" />
                                            <button onClick={() => {setUserProfile({...userProfile, name: tempName}); setIsEditingProfile(false)}} className="text-sm text-green-500 font-bold">حفظ</button>
                                        </div>
                                    ) : (
                                        <div className="flex items-center gap-2">
                                            <h3 className="text-2xl font-bold">{userProfile.name}</h3>
                                            <button onClick={() => setIsEditingProfile(true)}><Edit2 size={16} className="opacity-50" /></button>
                                        </div>
                                    )}
                                </div>
                                <div className="border-t border-gray-700 pt-6">
                                    <div className="flex justify-between items-center py-4">
                                        <div className="flex items-center gap-3"><Moon /> <span>الوضع الداكن</span></div>
                                        <button onClick={() => setTheme(isDark ? 'light' : 'dark')} className={`w-12 h-6 rounded-full relative transition-colors ${isDark ? 'bg-green-500' : 'bg-gray-300'}`}>
                                            <div className={`w-4 h-4 bg-white rounded-full absolute top-1 transition-all ${isDark ? 'left-1' : 'right-1'}`}></div>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
